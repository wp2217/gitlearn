FORM GET_DATA .
  DATA: POHEADER     TYPE TABLE OF BAPIMEPOHEADER WITH HEADER LINE,
        POHEADERX    TYPE TABLE OF BAPIMEPOHEADERX WITH HEADER LINE,
        POADDRVENDOR TYPE TABLE OF BAPIMEPOADDRVENDOR WITH HEADER LINE.
  DATA: RETURN    TYPE TABLE OF BAPIRET2 WITH HEADER LINE,
        GS_RETURN TYPE BAPIRET2,
        L_NUMBER  TYPE CHAR10,
        POITEM    LIKE TABLE OF BAPIMEPOITEM WITH HEADER LINE,
        POITEMX   LIKE TABLE OF BAPIMEPOITEMX WITH HEADER LINE.
  DATA GT_DATA TYPE TABLE OF ZMM018_ITEM WITH HEADER LINE.
  DATA EXPPURCHASEORDER LIKE BAPIMEPOHEADER-PO_NUMBER.
  "新增字段
  DATA:
    BAPI_TE_MEPOITEM    LIKE BAPI_TE_MEPOITEM,
    BAPI_TE_MEPOITEMX   LIKE BAPI_TE_MEPOITEMX,
    BAPI_TE_MEPOHEADER  LIKE BAPI_TE_MEPOHEADER,
    BAPI_TE_MEPOHEADERX LIKE BAPI_TE_MEPOHEADERX.

  DATA:L_EXTENSIONIN LIKE BAPIPAREX OCCURS 0 WITH HEADER LINE.
  DATA L_ITEM TYPE EBELP.
  DATA L_ZZSEQNO TYPE ZMM018_ITEM-ZZSEQNO.

  DATA: LT_TEMP TYPE STANDARD TABLE OF ZMM018_ITEM WITH HEADER LINE.
  LT_TEMP[] = LT_IMPORTDATA1[].

  DELETE LT_IMPORTDATA1[] WHERE STA = 'E'.
  SORT LT_IMPORTDATA1[] BY ZZSEQNO .
  DELETE ADJACENT DUPLICATES FROM LT_IMPORTDATA1 COMPARING ZZSEQNO.
  "新建
  LOOP AT LT_IMPORTDATA1 WHERE CHECK = 'I'.
    "一个单子下有错误，整个单子不再创建
    READ TABLE LT_TEMP TRANSPORTING NO FIELDS
      WITH KEY ZZSEQNO = LT_IMPORTDATA1-ZZSEQNO STA = 'E'.
    IF SY-SUBRC = 0.
      CONTINUE.
    ENDIF.

    CLEAR:
      POHEADER,
      POHEADERX,
      POADDRVENDOR.
    REFRESH:
      POHEADER[],
      POHEADERX[],
      POADDRVENDOR[],
      RETURN[],
      POITEM[],
      POITEMX[],
      L_EXTENSIONIN[].

    LOOP AT LT_IMPORTDATA WHERE ZZSEQNO = LT_IMPORTDATA1-ZZSEQNO AND STA NE 'E'.
      "poitem  heard
      "l_item = l_item + 10.
      IF LT_IMPORTDATA-BSART IS INITIAL.
        LT_IMPORTDATA-BSART = 'Z099'.
      ENDIF.
      POHEADER-DOC_TYPE     = LT_IMPORTDATA-BSART."采购凭证类型 PO Document Type
*      IF lt_importdata-bsart EQ 'Z099'.Bug #27088
      POHEADER-PO_NUMBER = LT_IMPORTDATA-ZZSEQNO. "Open PO Number
*      ENDIF.
      IF LT_IMPORTDATA-BEDAT IS INITIAL.
        POHEADER-DOC_DATE     = SY-DATUM. "采购日期 PO Document Date
      ELSE.
        POHEADER-DOC_DATE     = LT_IMPORTDATA-BEDAT. "采购日期 PO Document Date
      ENDIF.

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = LT_IMPORTDATA-LIFNR
        IMPORTING
          OUTPUT = LT_IMPORTDATA-LIFNR.

      POHEADER-VENDOR       = LT_IMPORTDATA-LIFNR.    "Vendor
      POHEADER-COMP_CODE    = LT_IMPORTDATA-BUKRS.    "Company Code
      POHEADER-PURCH_ORG    = LT_IMPORTDATA-EKORG.    "Purch. Org.
      POHEADER-PUR_GROUP    = LT_IMPORTDATA-EKGRP.    "Buyer Code
      POHEADER-CURRENCY     = LT_IMPORTDATA-WAERS.    "Currency
      POHEADER-INCOTERMS1   = LT_IMPORTDATA-INCO1.    "Incoterms
      POHEADER-INCOTERMS2L  = LT_IMPORTDATA-INCO2_L.  "Incoterms Location 1
      POHEADER-EXCH_RATE    = LT_IMPORTDATA-WKURS.    "Exchange Rate
      POHEADER-PMNTTRMS     = LT_IMPORTDATA-ZTERM.    "Payment Term
      POHEADER-TELEPHONE    = LT_IMPORTDATA-TELF1.    "Telephone
      POHEADER-REF_1        = LT_IMPORTDATA-IHREZ.    "Your Reference
      POHEADER-OUR_REF      = LT_IMPORTDATA-UNSEZ.    "Our Reference
      POHEADER-LANGU        = SY-LANGU.
      APPEND POHEADER.

      POHEADERX-PO_NUMBER    = 'X'.
      POHEADERX-DOC_TYPE     = 'X'.
      POHEADERX-DOC_DATE     = 'X'.
      POHEADERX-VENDOR       = 'X'.
      POHEADERX-COMP_CODE    = 'X'.
      POHEADERX-PURCH_ORG    = 'X'.
      POHEADERX-PUR_GROUP    = 'X'.
      POHEADERX-CURRENCY     = 'X'.
      POHEADERX-INCOTERMS1   = 'X'.
      POHEADERX-EXCH_RATE    = 'X'.
      POHEADERX-PMNTTRMS     = 'X'.
      POHEADERX-TELEPHONE    = 'X'.
      POHEADERX-REF_1        = 'X'.
      POHEADERX-OUR_REF      = 'X'.
      POHEADERX-LANGU        = 'X'.
      APPEND POHEADERX.

      "header 新增字段
      BAPI_TE_MEPOHEADER-ZZBOND_QCS  = LT_IMPORTDATA-Z_QCS."保稅/非保稅PO (QCS/QVH)
      BAPI_TE_MEPOHEADER-ZZBOND_QTY  = LT_IMPORTDATA-Z_QTY."保稅生產/非保稅生產PO (QTY)
      BAPI_TE_MEPOHEADER-ZZCUSTOMS   = LT_IMPORTDATA-Z_BOX."報關與否 checkbox
      BAPI_TE_MEPOHEADER-ZZVMI_TYPE  = LT_IMPORTDATA-Z_VMITYPE."VMI Type
      BAPI_TE_MEPOHEADER-ZZOTM_LIFNR = LT_IMPORTDATA-ZZOTM_LIFNR."OTM Real Vendor
      BAPI_TE_MEPOHEADER-ZZOTM_WERKS = LT_IMPORTDATA-ZZOTM_WERKS."OTM Real Plant
      BAPI_TE_MEPOHEADER-ZZOTM_SITE  = LT_IMPORTDATA-ZZOTM_SITE."OTM Real Company Code
      BAPI_TE_MEPOHEADER-ZZAPPROVAL  = LT_IMPORTDATA-ZZAPPROVAL."OTM Real Company Code

      BAPI_TE_MEPOHEADER-ZZSPART       = LT_IMPORTDATA-ZZSPART."Division
      BAPI_TE_MEPOHEADER-ZZAUART       = LT_IMPORTDATA-ZZAUART."SO order type
      BAPI_TE_MEPOHEADER-ZZFFAC       = LT_IMPORTDATA-ZZFFAC."From Facility
      BAPI_TE_MEPOHEADER-ZZTFAC       = LT_IMPORTDATA-ZZTFAC."To Facility
      BAPI_TE_MEPOHEADER-ZZTWERKS     = LT_IMPORTDATA-ZZTWERKS."To Plant
      BAPI_TE_MEPOHEADER-ZZHPRCTR     = LT_IMPORTDATA-ZZHPRCTR."Profit Center
      BAPI_TE_MEPOHEADER-ZZAGING_BLOCK_FLAG  = LT_IMPORTDATA-ZZAGING_BLOCK_FLAG."ZZAGING_BLOCK_FLAG
      BAPI_TE_MEPOHEADER-ZZCUSTOM_DOC_READY_FLAG  = LT_IMPORTDATA-ZZCUSTOM_DOC_READY_FLAG."Customs Document Ready Flag
      BAPI_TE_MEPOHEADER-ZZSHIPTO = LT_IMPORTDATA-ZZSHIPTO."Ship-to of Direct Shipment
      CLEAR L_EXTENSIONIN.
      MOVE 'BAPI_TE_MEPOHEADER' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOHEADER  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

      BAPI_TE_MEPOHEADERX-ZZBOND_QCS  = 'X'."保稅/非保稅PO (QCS/QVH)
      BAPI_TE_MEPOHEADERX-ZZBOND_QTY  = 'X'."保稅生產/非保稅生產PO (QTY)
      BAPI_TE_MEPOHEADERX-ZZCUSTOMS   = 'X'."報關與否 checkbox
      BAPI_TE_MEPOHEADERX-ZZVMI_TYPE  = 'X'."VMI Type
      BAPI_TE_MEPOHEADERX-ZZOTM_LIFNR = 'X'."OTM Real Vendor
      BAPI_TE_MEPOHEADERX-ZZOTM_WERKS = 'X'."OTM Real Plant
      BAPI_TE_MEPOHEADERX-ZZOTM_SITE  = 'X'."OTM Real Company Code
      BAPI_TE_MEPOHEADERX-ZZAPPROVAL  = 'X'."OTM Real Company Code

      BAPI_TE_MEPOHEADERX-ZZSPART       = 'X'."Division
      BAPI_TE_MEPOHEADERX-ZZAUART       = 'X'."SO order type
      BAPI_TE_MEPOHEADERX-ZZFFAC       = 'X'."From Facility
      BAPI_TE_MEPOHEADERX-ZZTFAC       = 'X'."To Facility
      BAPI_TE_MEPOHEADERX-ZZTWERKS     = 'X'."To Plant
      BAPI_TE_MEPOHEADERX-ZZHPRCTR     = 'X'."Profit Center
      BAPI_TE_MEPOHEADERX-ZZAGING_BLOCK_FLAG  = 'X'."HUB PO Hold
      BAPI_TE_MEPOHEADERX-ZZCUSTOM_DOC_READY_FLAG  = 'X'."Customs Document Ready Flag
      BAPI_TE_MEPOHEADERX-ZZSHIPTO = 'X'."Ship-to of Direct Shipment
      CLEAR L_EXTENSIONIN.
      MOVE 'BAPI_TE_MEPOHEADERX' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOHEADERX  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

      "poitem  item
      POITEM-PO_ITEM = LT_IMPORTDATA-EBELP .  "EBELP(Item)
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = POITEM-PO_ITEM
        IMPORTING
          OUTPUT = POITEM-PO_ITEM.
      POITEM-PLANT          = LT_IMPORTDATA-WERKS . "plant
      POITEM-MATERIAL       = LT_IMPORTDATA-MATNR. "Material
      POITEM-QUANTITY       = LT_IMPORTDATA-KTMNG . "PO Quantity
      POITEM-PO_UNIT        = LT_IMPORTDATA-UNIT . "单位
      POITEM-DATE_QTY_FIXED = LT_IMPORTDATA-LFDAT . "Plan Delivery Date
      POITEM-STGE_LOC       = LT_IMPORTDATA-LGORT. "Storage Location
      POITEM-ITEM_CAT       = LT_IMPORTDATA-EPSTP . "Item Category
      POITEM-ACCTASSCAT     = LT_IMPORTDATA-KNTTP . "Account Assignment Category
      POITEM-RET_ITEM       = LT_IMPORTDATA-RETPO . "Return RETPO
      POITEM-FREE_ITEM      = LT_IMPORTDATA-UMSON . "Free of Charge
      POITEM-NET_PRICE     = LT_IMPORTDATA-NETPR .
      POITEM-PRICE_UNIT     = LT_IMPORTDATA-PEINH . "Per
      POITEM-PO_UNIT        = LT_IMPORTDATA-MEINS . "Order Unit
      " POITEM-ORDERPR_UN     = LT_IMPORTDATA-NETPR . "Unit Price

      POITEM-TAX_CODE       = LT_IMPORTDATA-MWSKZ . "Tax Code
      POITEM-VAL_TYPE       = LT_IMPORTDATA-BWTAR . "Split Valuation
      POITEM-SHIPPING       = LT_IMPORTDATA-EVERS . "Split Valuation
      APPEND POITEM.

      POITEMX-PO_ITEM       = LT_IMPORTDATA-EBELP .  "EBELP
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = POITEMX-PO_ITEM
        IMPORTING
          OUTPUT = POITEMX-PO_ITEM.
      POITEMX-PLANT          = 'X' . "plant
      POITEMX-MATERIAL       = 'X' . "Material
      POITEMX-QUANTITY       = 'X' . "PO Quantity
      POITEMX-PO_UNIT        = 'X' . "单位
      POITEMX-DATE_QTY_FIXED = 'X' . "Plan Delivery Date
      POITEMX-STGE_LOC       = 'X' . "Storage Location
      POITEMX-ITEM_CAT       = 'X' . "Item Category
      POITEMX-ACCTASSCAT     = 'X' . "Account Assignment Category
      POITEMX-RET_ITEM       = 'X' .   "Return
      POITEMX-FREE_ITEM      = 'X' . "Free of Charge
      POITEMX-NET_PRICE     = 'X' . "Net Price
      POITEMX-PRICE_UNIT     = 'X' . "Unit Price
      POITEM-PO_UNIT         = 'X' . "Order Unit
      " POITEM-ORDERPR_UN      = 'X' . "Unit Price
      POITEM-TAX_CODE        = 'X' . "Tax Code
      APPEND POITEMX.

      "ITEM 新增字段
      BAPI_TE_MEPOITEM-PO_ITEM = LT_IMPORTDATA-EBELP.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = BAPI_TE_MEPOITEM-PO_ITEM
        IMPORTING
          OUTPUT = BAPI_TE_MEPOITEM-PO_ITEM.
      BAPI_TE_MEPOITEM-ZZMARK_EXCESS_MAT = LT_IMPORTDATA-ZZMARK_EXCESS_MAT. "呆料標示 (item level)
      BAPI_TE_MEPOITEM-ZZTMP_PRICE       = LT_IMPORTDATA-ZZTMP_PRICE. "Temp Price
      BAPI_TE_MEPOITEM-ZZCUSTOM_PRICE    = LT_IMPORTDATA-ZZCUSTOM_PRICE. "報關單價
      BAPI_TE_MEPOITEM-ZZMAKER_CODE      = LT_IMPORTDATA-ZZMAKER_CODE. "Maker Code
      BAPI_TE_MEPOITEM-ZZMAKER_PART      = LT_IMPORTDATA-ZZMAKER_PART. "Make Part Number
      CLEAR L_EXTENSIONIN.
      MOVE 'BAPI_TE_MEPOITEM' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOITEM  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

*Inform that the value contained in ZZINVERS MUST be read by BAPI
      BAPI_TE_MEPOITEMX-PO_ITEM = LT_IMPORTDATA-EBELP.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = BAPI_TE_MEPOITEMX-PO_ITEM
        IMPORTING
          OUTPUT = BAPI_TE_MEPOITEMX-PO_ITEM.
      BAPI_TE_MEPOITEMX-ZZMARK_EXCESS_MAT = 'X'.
      BAPI_TE_MEPOITEMX-ZZTMP_PRICE       = 'X'.
      BAPI_TE_MEPOITEMX-ZZCUSTOM_PRICE    = 'X'.
      BAPI_TE_MEPOITEMX-ZZMAKER_CODE      = 'X'.
      BAPI_TE_MEPOITEMX-ZZMAKER_PART      = 'X'.
      CLEAR L_EXTENSIONIN.
      MOVE 'BAPI_TE_MEPOITEMX' TO L_EXTENSIONIN-STRUCTURE.
      MOVE BAPI_TE_MEPOITEMX TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

*      IF lt_importdata-bsart EQ 'Z099'.Bug #27088
      POADDRVENDOR-PO_NUMBER = LT_IMPORTDATA-ZZSEQNO.
*      ENDIF.
      POADDRVENDOR-ADDR_NO   = LT_IMPORTDATA-ZADRN2.
      APPEND  POADDRVENDOR.
    ENDLOOP.

    CALL FUNCTION 'BAPI_PO_CREATE1'
      EXPORTING
        POHEADER         = POHEADER
        POHEADERX        = POHEADERX
        POADDRVENDOR     = POADDRVENDOR
      IMPORTING
        EXPPURCHASEORDER = EXPPURCHASEORDER
      TABLES
        RETURN           = RETURN
        POITEM           = POITEM
        POITEMX          = POITEMX
        EXTENSIONIN      = L_EXTENSIONIN.

    IF RETURN[] IS NOT INITIAL.
      LOOP AT RETURN INTO GS_RETURN WHERE TYPE = 'E' OR TYPE = 'A'.
        LT_IMPORTDATA1-STA = GS_RETURN-TYPE.
        IF LT_IMPORTDATA1-MESSAGE IS NOT INITIAL.
          CONCATENATE LT_IMPORTDATA1-MESSAGE GS_RETURN-MESSAGE INTO LT_IMPORTDATA1-MESSAGE SEPARATED BY '/ '.
        ELSE.
          LT_IMPORTDATA1-MESSAGE = GS_RETURN-MESSAGE.
        ENDIF.
      ENDLOOP.
      IF SY-SUBRC = 0.
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

      ELSE.
        LOOP AT RETURN INTO GS_RETURN WHERE TYPE = 'S'.
          L_NUMBER = GS_RETURN-MESSAGE_V2.
          LT_IMPORTDATA1-ZNUMBER = L_NUMBER.
          LT_IMPORTDATA1-MESSAGE = GS_RETURN-MESSAGE.
          LT_IMPORTDATA1-STA = 'S'.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              WAIT = 'X'.

          EXIT.
        ENDLOOP.
      ENDIF.

      DELETE RETURN[] WHERE TYPE = 'W' OR TYPE = 'I'.
      LT_IMPORTDATA1-MESSAGETAB = RETURN[].

    ENDIF.
    MODIFY LT_IMPORTDATA1.

    CLEAR :L_NUMBER,POHEADER[],POHEADERX[],EXPPURCHASEORDER,
    RETURN[],POITEM,POITEMX[],L_EXTENSIONIN,POHEADER,POHEADERX,
    RETURN,POITEM[],POITEMX,L_EXTENSIONIN.
  ENDLOOP.

  LOOP AT LT_IMPORTDATA WHERE STA NE 'E'.
    READ TABLE LT_IMPORTDATA1 WITH KEY ZZSEQNO = LT_IMPORTDATA-ZZSEQNO
                                        STA = 'S'.
    IF SY-SUBRC = 0 .
      LT_IMPORTDATA-ZNUMBER = LT_IMPORTDATA1-ZNUMBER.
      LT_IMPORTDATA-MESSAGE = LT_IMPORTDATA1-MESSAGE.
      LT_IMPORTDATA-MESSAGETAB = LT_IMPORTDATA1-MESSAGETAB.
      LT_IMPORTDATA-STA = 'S'.
    ENDIF.
    READ TABLE LT_IMPORTDATA1 WITH KEY ZZSEQNO = LT_IMPORTDATA-ZZSEQNO
                                       STA = 'E'.
    IF SY-SUBRC = 0 .
      LT_IMPORTDATA-STA = 'E'.
      LT_IMPORTDATA-MESSAGE = LT_IMPORTDATA1-MESSAGE .
      LT_IMPORTDATA-MESSAGETAB = LT_IMPORTDATA1-MESSAGETAB .
    ENDIF.
    MODIFY LT_IMPORTDATA.
  ENDLOOP.

  "修改
  CLEAR:POHEADER,POHEADER[],POHEADERX,POHEADERX[],BAPI_TE_MEPOHEADER,
        BAPI_TE_MEPOHEADERX,POITEM,POITEM[],POITEMX,POITEMX[],
        BAPI_TE_MEPOITEM,BAPI_TE_MEPOITEMX,
        RETURN[],RETURN .

  LOOP AT LT_IMPORTDATA1 WHERE CHECK = 'M'.
    "一个单子下有错误，整个单子不再创建
    READ TABLE LT_TEMP TRANSPORTING NO FIELDS
      WITH KEY ZZSEQNO = LT_IMPORTDATA1-ZZSEQNO STA = 'E'.
    IF SY-SUBRC = 0.
      CONTINUE.
    ENDIF.

    CLEAR :L_ZZSEQNO.
    LOOP AT LT_IMPORTDATA WHERE ZZSEQNO = LT_IMPORTDATA1-ZZSEQNO AND STA NE 'E' .
      IF LT_IMPORTDATA-BSART IS INITIAL.
        LT_IMPORTDATA-BSART = 'Z099'.
      ENDIF.
      POHEADER-DOC_TYPE     = LT_IMPORTDATA-BSART."采购凭证类型 PO Document Type

      POHEADER-PO_NUMBER = LT_IMPORTDATA-ZZSEQNO. "Open PO Number
      L_ZZSEQNO = LT_IMPORTDATA-ZZSEQNO.

      IF LT_IMPORTDATA-BEDAT IS INITIAL.
        POHEADER-DOC_DATE     = SY-DATUM. "采购日期 PO Document Date
      ELSE.
        POHEADER-DOC_DATE     = LT_IMPORTDATA-BEDAT. "采购日期 PO Document Date
      ENDIF.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = LT_IMPORTDATA-LIFNR
        IMPORTING
          OUTPUT = LT_IMPORTDATA-LIFNR.
      POHEADER-VENDOR       = LT_IMPORTDATA-LIFNR.    "Vendor
      POHEADER-COMP_CODE    = LT_IMPORTDATA-BUKRS.    "Company Code
      POHEADER-PURCH_ORG    = LT_IMPORTDATA-EKORG.    "Purch. Org.
      POHEADER-PUR_GROUP    = LT_IMPORTDATA-EKGRP.    "Buyer Code
      POHEADER-CURRENCY     = LT_IMPORTDATA-WAERS.    "Currency
      POHEADER-INCOTERMS1   = LT_IMPORTDATA-INCO1.    "Incoterms
      POHEADER-INCOTERMS2L  = LT_IMPORTDATA-INCO2_L.  "Incoterms Location 1
      POHEADER-EXCH_RATE    = LT_IMPORTDATA-WKURS.    "Exchange Rate
      POHEADER-PMNTTRMS     = LT_IMPORTDATA-ZTERM.    "Payment Term
      POHEADER-TELEPHONE    = LT_IMPORTDATA-TELF1.    "Telephone
      POHEADER-REF_1        = LT_IMPORTDATA-IHREZ.    "Your Reference
      POHEADER-OUR_REF      = LT_IMPORTDATA-UNSEZ.    "Our Reference
      POHEADER-LANGU        = SY-LANGU.
      APPEND POHEADER.

      POHEADERX-PO_NUMBER    = 'X'.
      POHEADERX-DOC_TYPE     = 'X'.
      POHEADERX-DOC_DATE     = 'X'.
      POHEADERX-VENDOR       = 'X'.
      POHEADERX-COMP_CODE    = 'X'.
      POHEADERX-PURCH_ORG    = 'X'.
      POHEADERX-PUR_GROUP    = 'X'.
      POHEADERX-CURRENCY     = 'X'.
      POHEADERX-INCOTERMS1   = 'X'.
      POHEADERX-EXCH_RATE    = 'X'.
      POHEADERX-PMNTTRMS     = 'X'.
      POHEADERX-TELEPHONE    = 'X'.
      POHEADERX-REF_1        = 'X'.
      POHEADERX-OUR_REF      = 'X'.
      POHEADERX-LANGU        = 'X'.
      APPEND POHEADERX.

      "header 新增字段
      BAPI_TE_MEPOHEADER-PO_NUMBER  = LT_IMPORTDATA-EBELN."PO
      BAPI_TE_MEPOHEADER-ZZBOND_QCS  = LT_IMPORTDATA-Z_QCS."保稅/非保稅PO (QCS/QVH)
      BAPI_TE_MEPOHEADER-ZZBOND_QTY  = LT_IMPORTDATA-Z_QTY."保稅生產/非保稅生產PO (QTY)
      BAPI_TE_MEPOHEADER-ZZCUSTOMS   = LT_IMPORTDATA-Z_BOX."報關與否 checkbox
      BAPI_TE_MEPOHEADER-ZZVMI_TYPE  = LT_IMPORTDATA-Z_VMITYPE."VMI Type
      BAPI_TE_MEPOHEADER-ZZOTM_LIFNR = LT_IMPORTDATA-ZZOTM_LIFNR."OTM Real Vendor
      BAPI_TE_MEPOHEADER-ZZOTM_WERKS = LT_IMPORTDATA-ZZOTM_WERKS."OTM Real Plant
      BAPI_TE_MEPOHEADER-ZZOTM_SITE  = LT_IMPORTDATA-ZZOTM_SITE."OTM Real Company Code
      BAPI_TE_MEPOHEADER-ZZAPPROVAL  = LT_IMPORTDATA-ZZAPPROVAL."OTM Real Company Code

      BAPI_TE_MEPOHEADER-ZZSPART       = LT_IMPORTDATA-ZZSPART."Division
      BAPI_TE_MEPOHEADER-ZZAUART       = LT_IMPORTDATA-ZZAUART."SO order type
      BAPI_TE_MEPOHEADER-ZZFFAC       = LT_IMPORTDATA-ZZFFAC."From Facility
      BAPI_TE_MEPOHEADER-ZZTFAC       = LT_IMPORTDATA-ZZTFAC."To Facility
      BAPI_TE_MEPOHEADER-ZZTWERKS     = LT_IMPORTDATA-ZZTWERKS."To Plant
      BAPI_TE_MEPOHEADER-ZZHPRCTR     = LT_IMPORTDATA-ZZHPRCTR."Profit Center
      BAPI_TE_MEPOHEADER-ZZAGING_BLOCK_FLAG  = LT_IMPORTDATA-ZZAGING_BLOCK_FLAG."ZZAGING_BLOCK_FLAG
      BAPI_TE_MEPOHEADER-ZZCUSTOM_DOC_READY_FLAG  = LT_IMPORTDATA-ZZCUSTOM_DOC_READY_FLAG."Customs Document Ready Flag
      BAPI_TE_MEPOHEADER-ZZSHIPTO = LT_IMPORTDATA-ZZSHIPTO."Ship-to of Direct Shipment
      MOVE 'BAPI_TE_MEPOHEADER' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOHEADER  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

      BAPI_TE_MEPOHEADERX-ZZBOND_QCS  = 'X'."保稅/非保稅PO (QCS/QVH)
      BAPI_TE_MEPOHEADERX-ZZBOND_QTY  = 'X'."保稅生產/非保稅生產PO (QTY)
      BAPI_TE_MEPOHEADERX-ZZCUSTOMS   = 'X'."報關與否 checkbox
      BAPI_TE_MEPOHEADERX-ZZVMI_TYPE  = 'X'."VMI Type
      BAPI_TE_MEPOHEADERX-ZZOTM_LIFNR = 'X'."OTM Real Vendor
      BAPI_TE_MEPOHEADERX-ZZOTM_WERKS = 'X'."OTM Real Plant
      BAPI_TE_MEPOHEADERX-ZZOTM_SITE  = 'X'."OTM Real Company Code
      BAPI_TE_MEPOHEADERX-ZZAPPROVAL  = 'X'."OTM Real Company Code

      BAPI_TE_MEPOHEADERX-ZZSPART       = 'X'."Division
      BAPI_TE_MEPOHEADERX-ZZAUART       = 'X'."SO order type
      BAPI_TE_MEPOHEADERX-ZZFFAC       = 'X'."From Facility
      BAPI_TE_MEPOHEADERX-ZZTFAC       = 'X'."To Facility
      BAPI_TE_MEPOHEADERX-ZZTWERKS     = 'X'."To Plant
      BAPI_TE_MEPOHEADERX-ZZHPRCTR     = 'X'."Profit Center
      BAPI_TE_MEPOHEADERX-ZZAGING_BLOCK_FLAG  = 'X'."ZZAGING_BLOCK_FLAG
      BAPI_TE_MEPOHEADERX-ZZCUSTOM_DOC_READY_FLAG  = 'X'."Customs Document Ready Flag
      BAPI_TE_MEPOHEADERX-ZZSHIPTO = 'X'."Ship-to of Direct Shipment
      MOVE 'BAPI_TE_MEPOHEADERX' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOHEADERX  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.

      "poitem  item
      POITEM-PO_ITEM = LT_IMPORTDATA-EBELP .  "EBELP(Item)
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = POITEM-PO_ITEM
        IMPORTING
          OUTPUT = POITEM-PO_ITEM.
      POITEM-PLANT          = LT_IMPORTDATA-WERKS . "plant
      POITEM-MATERIAL       = LT_IMPORTDATA-MATNR. "Material
      POITEM-QUANTITY       = LT_IMPORTDATA-KTMNG . "PO Quantity
      POITEM-PO_UNIT        = LT_IMPORTDATA-UNIT . "单位
      POITEM-DATE_QTY_FIXED = LT_IMPORTDATA-LFDAT . "Plan Delivery Date
      POITEM-STGE_LOC       = LT_IMPORTDATA-LGORT. "Storage Location
      POITEM-ITEM_CAT       = LT_IMPORTDATA-EPSTP . "Item Category
      POITEM-ACCTASSCAT     = LT_IMPORTDATA-KNTTP . "Account Assignment Category
      POITEM-RET_ITEM       = LT_IMPORTDATA-RETPO . "Return RETPO
      POITEM-FREE_ITEM      = LT_IMPORTDATA-UMSON . "Free of Charge
      POITEM-NET_PRICE     = LT_IMPORTDATA-NETPR.
      POITEM-PRICE_UNIT     = LT_IMPORTDATA-PEINH . "Per
      POITEM-PO_UNIT        = LT_IMPORTDATA-MEINS . "Order Unit
      " POITEM-ORDERPR_UN     = LT_IMPORTDATA-NETPR . "Unit Price

      POITEM-TAX_CODE       = LT_IMPORTDATA-MWSKZ . "Tax Code
      POITEM-VAL_TYPE       = LT_IMPORTDATA-BWTAR . "Split Valuation
      POITEM-SHIPPING       = LT_IMPORTDATA-EVERS . "Split Valuation
      APPEND POITEM.

      POITEMX-PO_ITEM       = LT_IMPORTDATA-EBELP .  "EBELP
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = POITEMX-PO_ITEM
        IMPORTING
          OUTPUT = POITEMX-PO_ITEM.
      POITEMX-PLANT          = 'X' . "plant
      POITEMX-MATERIAL       = 'X' . "Material
      POITEMX-QUANTITY       = 'X' . "PO Quantity
      POITEMX-PO_UNIT        = 'X' . "单位
      POITEMX-DATE_QTY_FIXED = 'X' . "Plan Delivery Date
      POITEMX-STGE_LOC       = 'X' . "Storage Location
      POITEMX-ITEM_CAT       = 'X' . "Item Category
      POITEMX-ACCTASSCAT     = 'X' . "Account Assignment Category
      POITEMX-RET_ITEM       = 'X' .   "Return
      POITEMX-FREE_ITEM      = 'X' . "Free of Charge
      POITEMX-NET_PRICE     = 'X' . "Net Price
      POITEMX-PRICE_UNIT     = 'X' . "Unit Price
      POITEM-PO_UNIT         = 'X' . "Order Unit
      "POITEM-ORDERPR_UN      = 'X' . "Unit Price
      POITEM-TAX_CODE        = 'X' . "Tax Code
      APPEND POITEMX.

      "ITEM 新增字段
      BAPI_TE_MEPOITEM-PO_ITEM = LT_IMPORTDATA-EBELP.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = BAPI_TE_MEPOITEM-PO_ITEM
        IMPORTING
          OUTPUT = BAPI_TE_MEPOITEM-PO_ITEM.
      BAPI_TE_MEPOITEM-ZZMARK_EXCESS_MAT = LT_IMPORTDATA-ZZMARK_EXCESS_MAT. "呆料標示 (item level)
      BAPI_TE_MEPOITEM-ZZTMP_PRICE       = LT_IMPORTDATA-ZZTMP_PRICE. "Temp Price
      BAPI_TE_MEPOITEM-ZZCUSTOM_PRICE    = LT_IMPORTDATA-ZZCUSTOM_PRICE. "報關單價
      BAPI_TE_MEPOITEM-ZZMAKER_CODE      = LT_IMPORTDATA-ZZMAKER_CODE. "Maker Code
      BAPI_TE_MEPOITEM-ZZMAKER_PART      = LT_IMPORTDATA-ZZMAKER_PART. "Make Part Number

      MOVE 'BAPI_TE_MEPOITEM' TO L_EXTENSIONIN-STRUCTURE.
      MOVE  BAPI_TE_MEPOITEM  TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.
*Inform that the value contained in ZZINVERS MUST be read by BAPI
      BAPI_TE_MEPOITEMX-PO_ITEM = LT_IMPORTDATA-EBELP.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          INPUT  = BAPI_TE_MEPOITEMX-PO_ITEM
        IMPORTING
          OUTPUT = BAPI_TE_MEPOITEMX-PO_ITEM.
      BAPI_TE_MEPOITEMX-ZZMARK_EXCESS_MAT = 'X'.
      BAPI_TE_MEPOITEMX-ZZTMP_PRICE       = 'X'.
      BAPI_TE_MEPOITEMX-ZZCUSTOM_PRICE    = 'X'.
      BAPI_TE_MEPOITEMX-ZZMAKER_CODE      = 'X'.
      BAPI_TE_MEPOITEMX-ZZMAKER_PART      = 'X'.

      MOVE 'BAPI_TE_MEPOITEMX' TO L_EXTENSIONIN-STRUCTURE.
      MOVE BAPI_TE_MEPOITEMX TO L_EXTENSIONIN-VALUEPART1.
      APPEND L_EXTENSIONIN.
    ENDLOOP.

    "修改po的bapi
    CALL FUNCTION 'BAPI_PO_CHANGE'
      EXPORTING
        PURCHASEORDER = L_ZZSEQNO
        POHEADER      = POHEADER
        POHEADERX     = POHEADERX
        POADDRVENDOR  = POADDRVENDOR
      TABLES
        RETURN        = RETURN
        POITEM        = POITEM
        POITEMX       = POITEMX
        EXTENSIONIN   = L_EXTENSIONIN.

    IF RETURN[] IS NOT INITIAL.
      LOOP AT RETURN INTO GS_RETURN WHERE TYPE = 'E'.
        LT_IMPORTDATA1-STA = GS_RETURN-TYPE.
        IF LT_IMPORTDATA1-MESSAGE IS NOT INITIAL.
          CONCATENATE LT_IMPORTDATA1-MESSAGE GS_RETURN-MESSAGE INTO LT_IMPORTDATA1-MESSAGE SEPARATED BY '/ '.
        ELSE.
          LT_IMPORTDATA1-MESSAGE = GS_RETURN-MESSAGE.
        ENDIF.
      ENDLOOP.
      IF SY-SUBRC = 0.
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

      ELSE.
        LOOP AT RETURN INTO GS_RETURN WHERE TYPE = 'S'.
          L_NUMBER = GS_RETURN-MESSAGE_V2.
          LT_IMPORTDATA1-ZNUMBER = L_NUMBER.
          LT_IMPORTDATA1-MESSAGE = GS_RETURN-MESSAGE.
          LT_IMPORTDATA1-STA = 'S'.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              WAIT = 'X'.

          EXIT.
        ENDLOOP.
      ENDIF.

      DELETE RETURN[] WHERE TYPE = 'W' OR TYPE = 'I'.
      LT_IMPORTDATA1-MESSAGETAB = RETURN[].
    ENDIF.
    MODIFY LT_IMPORTDATA1.

    CLEAR :L_NUMBER,POHEADER[],POHEADERX[],EXPPURCHASEORDER,
    RETURN[],POITEM,POITEMX[],L_EXTENSIONIN,POHEADER,POHEADERX,
    RETURN,POITEM[],POITEMX,L_EXTENSIONIN.

    LOOP AT LT_IMPORTDATA WHERE STA NE 'E'.
      READ TABLE LT_IMPORTDATA1 WITH KEY ZZSEQNO = LT_IMPORTDATA-ZZSEQNO
                                          STA = 'S'.
      IF SY-SUBRC = 0 .
        LT_IMPORTDATA-ZNUMBER = LT_IMPORTDATA1-ZNUMBER.
        LT_IMPORTDATA-MESSAGE = LT_IMPORTDATA1-MESSAGE.
        LT_IMPORTDATA-MESSAGETAB = LT_IMPORTDATA1-MESSAGETAB.
        LT_IMPORTDATA-STA = 'S'.
      ENDIF.
      READ TABLE LT_IMPORTDATA1 WITH KEY ZZSEQNO = LT_IMPORTDATA-ZZSEQNO
                                         STA = 'E'.
      IF SY-SUBRC = 0 .
        LT_IMPORTDATA-STA = 'E'.
        LT_IMPORTDATA-MESSAGETAB = LT_IMPORTDATA1-MESSAGETAB .
      ENDIF.
      MODIFY LT_IMPORTDATA.
    ENDLOOP.
  ENDLOOP.

ENDFORM.